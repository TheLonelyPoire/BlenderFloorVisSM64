# BlenderFloorVisSM64

A quick Blender script for visualizing the floor unit squares of Super Mario 64 for arbitrary geometry. 


## Installation/Setup

The installation/setup process is a bit scuffed, but the steps are as follows:
1. Download the python file from here (hereafter referred to as the script).
2. Open Blender, and then open both a Text Window and a 3D Viewport Window.
3. Open the sidebar of the 3D Viewport if it isn't already open by pressing N or using the small arrow on the top-right of the viewport.
4. Open the script in the Text Window using the file browser in the toolbar and click Run.
5. Open the menu on the sidebar of the 3D Viewport labeled "Floor Shenanigans."
6. Expand the panel labeled "Floor Unit Visualizer."


## Overview

This script works by defining a square grid, sampling the Blender scene at the top-left corners of each square in the grid, using ray casting to identify the height of the ground at each of these points, and finally, generating the boxes corresponding to the floor collisions. Note that the floor squares shown do include the region 78 units below the floor used for snapping Mario upwards during ground/air/water movement, but they do *not* include the region 100 units above the floor used for snapping Mario downwards during ground movement. For more information on how floors behave in Super Mario 64, I recommend watching the Floors section of [this instructional video](https://youtu.be/UnU7DJXiMAQ?t=1130).

## Settings

Here I walk through all of the settings in the Floor Unit Visualizer panel to hopeful address any confusion. For now, the "Create/Update Squares" button needs to be pressed after changing any of these settings for the changes to take effect.

**Show Unit Squares** - this setting will toggle the visibility of all the unit squares generated by the script. 

**Sample Grid Center** - this is the 2D center (X,Y) of the sampled grid in the Blender scene. By default it is set to (0,0), but it can be changed to fit the user's needs if desired.

**Sample Grid Dimensions** - these are the number of grid squares sampled in the X and Y directions respectively. By default a 10 x 10 grid is used, but these dimensions can be decreased or increased to suit the user's needs. Note that more squares means longer computation times.

**Unit Square Size** - this setting sets the size of the individual grid squares in Blender units. In Super Mario 64, unit squares are always 1x1 squares, but I included a scaling factor in case a particular Blender scene's units aren't the same as those of Super Mario 64.

**Sample Starting Height** - this setting defines the starting height for the rays cast from the sky for sampling the grid. It is set by default to 5000, but can be raised if the scene exceeds this height.

**Sample Offset Height** - this setting allows the user to shift the squares above the sampled surface by a slight amount to avoid z-fighting between the surface and the generated unit squares. For best results, it should be increased up to the point where the z-fighting stops, and no further.

**Sample Scale Adjustment** - this setting allows the user to scale down the generated unit cubes by a small factor. It was included because some calls to Blender's ray casting resulted in intersecting the previously generated floor unit squares if the floor unit squares were generated with their full width. This small reduction  eliminated these intersections. For best results, it should be decreased from 1 until the point where no extra floors are drawn, and no further. In practice, 0.99 has given reasonable results.

**Unit Square Color (X-Projecting Normal)** - the color assigned to the faces of the cubes with normals lying along the X-axis.

**Unit Square Color (Y-Projecting Normal)** - the color assigned to the faces of the cubes with normals lying along the Y-axis.

**Unit Square Color (Z-Projecting Normal)** - the color assigned to the faces of the cubes with normals lying along the Z-axis.

**Refresh Material** - this toggle, when set to True, forces the material to be regenerated on every call to "Create/Update Squares." When set to False, only the material colors are update on each call to "Create/Update Squares." It was included because I found during testing that when I messed up the material, it would stay broken until I restarted Blender to fix it. This setting eliminates the need for a Blender reset.

**Create/Update Squares** - this button actually generates the squares. 

## Recently Added Features/Bug Fixes

- Separated the material adjustment, visibility toggle, and square generation logic. Materials and visibility can now be changed without regenerating squares, which makes changing these settings much more responsive.
- Fixed unit square height not scaling with the unit square slider.
- Fixed RGB color wheels having an unused alpha setting.

## Notes/Potential Future Improvements

- Right now the raycasting is done sequentially, but it would be much faster if it could be done in parallel. Blender has existing ray-tracing capabilities, and tapping into those would likely significantly increase the speed at which the squares are generated (or equivalently, the number of squares that can be generated in the same amount of time).
- The need for a sample offset/scaling adjustment could be removed by performing/storing all ray samples before generating square geometry, so it would be nice to re-write the generation process to work this way. 
- Right now only the highest-most surface is found, and it is automatically treated as a floor, but it might be nice in the future to recognize ceilings from floors using surface normals and display both (or one or the other depending on user settings). 
